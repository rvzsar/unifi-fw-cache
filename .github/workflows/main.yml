name: UniFi Firmware Mirror

on:
  workflow_dispatch:
    inputs:
      models:
        description: 'Models (space separated)'
        default: 'U7PG2'
        type: string
      force_refresh:
        description: 'Force re-download'
        default: false
        type: boolean

  schedule:
    - cron: '0 3 * * 0'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "mirror-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  mirror:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - uses: actions/checkout@v4

      # --- CACHE: ÐÐµ ÐºÐ°Ñ‡Ð°ÐµÐ¼ Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ ---
      - uses: actions/cache@v4
        id: cache
        with:
          path: |
            firmware/firmware/
            firmware/firmware.json
          key: fw-${{ hashFiles('scripts/unifi-fw-cache.sh') }}-${{ github.run_id }}
          restore-keys: fw-${{ hashFiles('scripts/unifi-fw-cache.sh') }}-

      # --- PHASE 1: Fetch Catalog ---
      - name: Update Catalog
        id: catalog
        run: |
          set -euo pipefail
          mkdir -p firmware/firmware
          
          # Ð•ÑÐ»Ð¸ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑƒÐ¼ÐµÐµÑ‚ --fetch-catalog-api
          if ./scripts/unifi-fw-cache.sh --help 2>&1 | grep -q fetch-catalog-api; then
            ./scripts/unifi-fw-cache.sh \
              --fetch-catalog-api \
              --mirror-root ./firmware \
              --no-restart
          else
            # Native fallback: API Ubiquiti
            curl -sL \
              -H "Accept: application/json" \
              -A "Mozilla/5.0 (compatible; FirmwareBot/1.0)" \
              "https://fw-download.ubnt.com/data/firmware.json" \
              -o firmware/firmware.json
          fi
          
          # Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ
          jq -e 'type == "object"' firmware/firmware.json || {
            echo "::error::Invalid catalog JSON"
            exit 1
          }
          
          echo "count=$(jq 'keys | length' firmware/firmware.json)" >> $GITHUB_OUTPUT

      # --- PHASE 2: Mirror Binaries ---
      - name: Download Firmware
        id: download
        env:
          MODELS: ${{ github.event.inputs.models || 'U7PG2' }}
          FORCE: ${{ github.event.inputs.force_refresh || 'false' }}
          MIRROR_URL: "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/firmware"
        run: |
          set -euo pipefail
          
          FILTER=$(echo "$MODELS" | tr ' ' '|' | sed 's/^/^(/; s/$/)$/')
          DOWNLOADED=0
          SKIPPED=0
          FAILED=0
          
          # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¿ÐµÑ€Ð²Ñ‹Ð¼
          if ./scripts/unifi-fw-cache.sh --help 2>&1 | grep -q mirror-all; then
            echo "Using unifi-fw-cache.sh..."
            ./scripts/unifi-fw-cache.sh \
              --mirror-all \
              --mirror-root ./firmware \
              --filter "$FILTER" \
              --rewrite-catalog-host "$MIRROR_URL" \
              ${FORCE == 'true' && echo '--no-cache' || echo '--skip-existing'}
          else
            # High-level manual mirror Ñ parallel download
            echo "Using built-in mirror logic..."
            
            for MODEL in $MODELS; do
              echo "::group::Model: $MODEL"
              
              # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ URL'Ñ‹ (Ñ€ÐµÐºÑƒÑ€ÑÐ¸Ð²Ð½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº Ð²Ð¾ Ð²ÑÐµÑ… Ð²Ð»Ð¾Ð¶ÐµÐ½Ð½Ð¾ÑÑ‚ÑÑ…)
              jq -r --arg m "$MODEL" '
                .[$m] | 
                .. | 
                objects | 
                select(.url? or .file_url?) | 
                (.url // .file_url)
              ' firmware/firmware.json 2>/dev/null | while read -r URL; do
                [ -z "$URL" ] && continue
                
                FILE=$(basename "$URL" | cut -d'?' -f1)
                DIR="firmware/firmware/$MODEL"
                TARGET="$DIR/$FILE"
                
                mkdir -p "$DIR"
                
                if [ -f "$TARGET" ] && [ "$FORCE" != "true" ]; then
                  echo "  â­ï¸  $FILE (cached)"
                  ((SKIPPED++)) || true
                  continue
                fi
                
                echo "  â¬‡ï¸  $FILE"
                if wget -q --timeout=120 --tries=3 -O "$TARGET.tmp" "$URL"; then
                  mv "$TARGET.tmp" "$TARGET"
                  
                  # Rewrite URL Ð² ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³Ðµ
                  sed -i "s|$URL|$MIRROR_URL/$MODEL/$FILE|g" firmware/firmware.json
                  
                  # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ…ÐµÑˆ ÐµÑÐ»Ð¸ Ð±Ñ‹Ð» Ð² JSON
                  HASH=$(jq -r --arg u "$URL" '.. | objects | select(.url == $u or .file_url == $u) | .md5 // .sha256 // empty' firmware/firmware.json | head -1)
                  [ -n "$HASH" ] && echo "$HASH  $FILE" > "$TARGET.md5"
                  
                  ((DOWNLOADED++)) || true
                else
                  echo "::warning::Failed: $URL"
                  rm -f "$TARGET.tmp"
                  ((FAILED++)) || true
                fi
              done
              
              echo "::endgroup::"
            done
          fi
          
          echo "downloaded=$DOWNLOADED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

      # --- VALIDATION ---
      - name: Verify & Index
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡ÐµÐºÑÑƒÐ¼Ð¼Ñ‹
          find firmware/firmware -name "*.md5" | head -5 | while read -r f; do
            cd "$(dirname "$f")" && md5sum -c "$(basename "$f")" 2>/dev/null || true
            cd - >/dev/null
          done
          
          # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ index.html
          cat > firmware/index.html << EOF
          <!DOCTYPE html>
          <html><head>
            <meta charset="utf-8">
            <title>UniFi Firmware Mirror</title>
            <style>
              body{font-family:system-ui,sans-serif;max-width:900px;margin:2rem auto;padding:0 1rem}
              table{width:100%;border-collapse:collapse}td,th{border:1px solid #ddd;padding:8px}
              th{background:#f5f5f5}tr:hover{background:#f9f9f9}
            </style>
          </head><body>
          <h1>ðŸ”§ UniFi Firmware Mirror</h1>
          <p>Updated: $(date -u +"%Y-%m-%d %H:%M UTC") | Repo: ${{ github.repository }}</p>
          <table>
          <tr><th>Model</th><th>File</th><th>Size</th><th>Modified</th></tr>
          EOF
          
          find firmware/firmware -type f ! -name "*.md5" ! -name "*.sha256" ! -name "*.json" -printf "%P\n" | \
          while read -r line; do
            MODEL=$(dirname "$line")
            FILE=$(basename "$line")
            SIZE=$(du -h "firmware/firmware/$line" | cut -f1)
            DATE=$(stat -c "%y" "firmware/firmware/$line" | cut -d' ' -f1)
            echo "<tr><td>$MODEL</td><td><a href=\"firmware/$line\">$FILE</a></td><td>$SIZE</td><td>$DATE</td></tr>" >> firmware/index.html
          done
          
          echo "</table></body></html>" >> firmware/index.html

      # --- DEPLOY (atomic) ---
      - uses: actions/configure-pages@v5
      
      - uses: actions/upload-pages-artifact@v3
        with:
          path: './firmware'
          retention-days: 5
      
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4

      # --- REPORT ---
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Mirror Report" >> $GITHUB_STEP_SUMMARY
          echo "- Models: ${{ github.event.inputs.models || 'U7PG2' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Catalog entries: ${{ steps.catalog.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Downloaded: ${{ steps.download.outputs.downloaded || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Skipped (cached): ${{ steps.download.outputs.skipped || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Failed: ${{ steps.download.outputs.failed || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
