name: Cache UniFi U7PG2 Firmware
on:
  schedule:
    - cron: '0 0 * * 0'  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ –ø–æ–ª–Ω–æ—á—å –ø–æ UTC
  workflow_dispatch:      # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –∑–∞–¥–∞—á—É –≤—Ä—É—á–Ω—É—é –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
jobs:
  cache-firmware:
    runs-on: ubuntu-latest
    env:
      DEVICE_CODE: 'U7PG2'  # –¶–µ–ª–µ–≤–æ–π –∫–æ–¥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      FIRMWARE_CATALOG_URL: 'https://fw-update.ubnt.com/api/firmware-latest?filter=eq~~product~~unifi-firmware&filter=eq~~channel~~release&limit=5000'
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4
      - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      - name: üîç –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ—à–∏–≤–æ–∫ –∏ –Ω–∞–π—Ç–∏ U7PG2
        run: |
          # –°–∫–∞—á–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ —á–µ—Ä–µ–∑ API
          curl -s -o firmware_api.json "$FIRMWARE_CATALOG_URL"
          # –ò—â–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—à–∏–≤–∫–µ –¥–ª—è U7PG2
          if cat firmware_api.json | jq -e --arg dev "$DEVICE_CODE" '._embedded.firmware[] | select(.platform == $dev)' > firmware_info.json; then
            echo "–ü—Ä–æ—à–∏–≤–∫–∞ –¥–ª—è $DEVICE_CODE –Ω–∞–π–¥–µ–Ω–∞"
          else
            echo "–ü—Ä–æ—à–∏–≤–∫–∞ –¥–ª—è $DEVICE_CODE –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ"
            exit 0
          fi
      - name: ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –ø—Ä–æ—à–∏–≤–∫—É
        run: |
          # –ò–∑–≤–ª–µ–∫–∞–µ–º URL –∏ –≤–µ—Ä—Å–∏—é
          FW_URL=$(jq -r '._links.data.href' firmware_info.json)
          FW_VERSION=$(jq -r '.version' firmware_info.json)
          FW_FILENAME="U7PG2_${FW_VERSION}.bin"
          echo "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ: $FW_VERSION"
          curl -s -L -o "$FW_FILENAME" "$FW_URL"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
          FILESIZE=$(stat -c%s "$FW_FILENAME")
          echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $FILESIZE –±–∞–π—Ç"
          
          if [ "$FILESIZE" -lt 1000000 ]; then
            echo "‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª ($FILESIZE –±–∞–π—Ç), –≤–æ–∑–º–æ–∂–Ω–æ –æ—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è"
            exit 1
          fi
          
          echo "–°–∫–∞—á–∞–Ω–æ: $FW_FILENAME"
      - name: üìù –°–æ–∑–¥–∞—Ç—å Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "U7PG2-${{ github.run_id }}"
          name: "UniFi U7PG2 Firmware ${{ steps.date.outputs.formattedDate }}"
          body: |
            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è –ø—Ä–æ—à–∏–≤–∫–∞ –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ U7PG2.
            –í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏: ${{ steps.firmware-info.outputs.version }}
            –î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏: ${{ steps.date.outputs.formattedDate }}
            –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ —Ä–µ–ª–∏–∑–µ.
          files: "*.bin"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: üßπ –£–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        run: rm -f firmware_api.json firmware_info.json *.bin
