name: Mirror Firmware

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download firmware
        run: |
          mkdir -p firmware/firmware
          
          # Скачиваем каталог через API Ubiquiti
          curl -s "https://api.ui.com/v1/firmware/" \
            -H "Accept: application/json" \
            -o firmware/firmware.json
          
          # Или если API не работает, используем прямой URL (если доступен)
          # curl -s "https://fw-download.ubnt.com/data/firmware.json" -o firmware/firmware.json
          
          # Парсим модели (U7PG2 по умолчанию)
          MODELS="${{ github.event.inputs.models || 'U7PG2' }}"
          
          for MODEL in $MODELS; do
            echo "Processing $MODEL..."
            
            # Ищем URL в JSON (адаптируй под структуру API)
            URL=$(jq -r --arg model "$MODEL" '
              .[] | select(.platform_id == $model) | 
              .channel.release[0].file_url
            ' firmware/firmware.json)
            
            if [ -n "$URL" ] && [ "$URL" != "null" ]; then
              FILENAME=$(basename "$URL")
              mkdir -p "firmware/firmware/$MODEL"
              
              echo "Downloading $FILENAME..."
              wget -q --show-progress -O "firmware/firmware/$MODEL/$FILENAME" "$URL"
              
              # Сохраняем MD5 если есть
              MD5=$(jq -r --arg model "$MODEL" '
                .[] | select(.platform_id == $model) | 
                .channel.release[0].md5
              ' firmware/firmware.json)
              
              echo "$MD5  $FILENAME" > "firmware/firmware/$MODEL/$FILENAME.md5"
            else
              echo "Model $MODEL not found in catalog"
            fi
          done
          
          # Переписываем хосты в JSON для локального зеркала
          REPO="${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          jq --arg host "https://$REPO/firmware" '
            walk(
              if type == "string" and startswith("https://fw-download.ubnt.com") then
                sub("https://fw-download.ubnt.com/data/firmware"; $host)
              else
                .
              end
            )
          ' firmware/firmware.json > firmware/firmware.json.tmp
          mv firmware/firmware.json.tmp firmware/firmware.json
      
      - name: Commit
        run: |
          git config user.name "bot"
          git config user.email "bot@users.noreply.github.com"
          git add firmware/
          git commit -m "update $(date +%F)" || echo "no changes"
          git push
      
      - uses: actions/configure-pages@v4
      - uses: actions/upload-pages-artifact@v3
        with:
          path: './firmware'
      - uses: actions/deploy-pages@v4
