name: Cache UniFi Firmware
on:
  schedule:
    - cron: '0 0 1 * *'  # 1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
  workflow_dispatch:
    inputs:
      devices:
        description: '–ö–æ–¥—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é'
        required: false
        default: 'U7PG2'

jobs:
  cache-firmware:
    runs-on: ubuntu-latest
    env:
      FIRMWARE_CATALOG_URL: 'https://fw-update.ubnt.com/api/firmware-latest?'
    steps:
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è —Ç–µ–≥–æ–≤
      
      - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: üîç –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–ª–µ–≤—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        id: set-devices
        run: |
          if [ -n "${{ github.event.inputs.devices }}" ]; then
            DEVICES="${{ github.event.inputs.devices }}"
          else
            DEVICES="U7PG2"
          fi
          echo "devices=${DEVICES}" >> $GITHUB_OUTPUT
          echo "devices_array=${DEVICES//,/ }" >> $GITHUB_ENV

      - name: üì• –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ—à–∏–≤–æ–∫
        run: curl -s -o firmware_api.json "$FIRMWARE_CATALOG_URL"

      - name: üîÑ –ù–∞–π—Ç–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        id: check-updates
        run: |
          echo "## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π:" > updates_info.md
          UPDATES_FOUND=0
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–ª–∏–∑ —Å –ø—Ä–æ—à–∏–≤–∫–∞–º–∏
          LATEST_TAG=$(git describe --tags --match "firmware-*" --abbrev=0 2>/dev/null || echo "none")
          
          if [ "$LATEST_TAG" != "none" ]; then
            echo "–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–ª–∏–∑: $LATEST_TAG"
            
            # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª—ã –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–ª–∏–∑–∞
            git checkout $LATEST_TAG -- *.bin 2>/dev/null || true
          fi
          
          for DEVICE in $devices_array; do
            echo -e "\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ $DEVICE ==="
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤–æ–π –ø—Ä–æ—à–∏–≤–∫–µ
            if jq -e --arg dev "$DEVICE" '._embedded.firmware[] | select(.platform == $dev)' firmware_api.json > "firmware_${DEVICE}.json" 2>/dev/null; then
              NEW_VERSION=$(jq -r '.version' "firmware_${DEVICE}.json")
              NEW_URL=$(jq -r '._links.data.href' "firmware_${DEVICE}.json")
              
              # –ò—â–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª—ã)
              CURRENT_FILE=$(ls ${DEVICE}_*.bin 2>/dev/null | head -1)
              
              if [ -f "$CURRENT_FILE" ]; then
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                CURRENT_VERSION=$(echo "$CURRENT_FILE" | grep -oP "${DEVICE}_\K[^\.]+(?=\.bin)")
                echo "–¢–µ–∫—É—â–∞—è: $CURRENT_VERSION"
                echo "–ù–æ–≤–∞—è:   $NEW_VERSION"
                
                if [ "$CURRENT_VERSION" != "$NEW_VERSION" ]; then
                  echo "‚ö†Ô∏è –ù–ê–ô–î–ï–ù–û –û–ë–ù–û–í–õ–ï–ù–ò–ï!"
                  echo "$DEVICE|$NEW_VERSION|$NEW_URL|update" >> devices_info.txt
                  echo "- **$DEVICE**: $CURRENT_VERSION ‚Üí $NEW_VERSION üîÑ" >> updates_info.md
                  UPDATES_FOUND=$((UPDATES_FOUND + 1))
                else
                  echo "‚úÖ –í–µ—Ä—Å–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞"
                  echo "$DEVICE|$NEW_VERSION|$NEW_URL|current" >> devices_info.txt
                  echo "- $DEVICE: $CURRENT_VERSION (–∞–∫—Ç—É–∞–ª—å–Ω–æ)" >> updates_info.md
                fi
              else
                # –§–∞–π–ª–∞ –Ω–µ—Ç, —Å–∫–∞—á–∏–≤–∞–µ–º –ø–µ—Ä–≤—É—é –≤–µ—Ä—Å–∏—é
                echo "‚ö†Ô∏è –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç —Å–∫–∞—á–∞–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è"
                echo "$DEVICE|$NEW_VERSION|$NEW_URL|new" >> devices_info.txt
                echo "- **$DEVICE**: –Ω–æ–≤–∞—è –ø—Ä–æ—à–∏–≤–∫–∞ $NEW_VERSION üì•" >> updates_info.md
                UPDATES_FOUND=$((UPDATES_FOUND + 1))
              fi
            else
              echo "‚ùå –ü—Ä–æ—à–∏–≤–∫–∞ –¥–ª—è $DEVICE –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            fi
          done
          
          echo "updates_found=$UPDATES_FOUND" >> $GITHUB_OUTPUT
          echo "–ù–∞–π–¥–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: $UPDATES_FOUND"

      - name: ‚è© –ü—Ä–æ–ø—É—Å–∫ –µ—Å–ª–∏ –Ω–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        if: steps.check-updates.outputs.updates_found == '0'
        run: |
          echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É"
          echo "### –û—Ç—á–µ—Ç:" > report.md
          cat updates_info.md >> report.md
          echo "" >> report.md
          echo "‚úÖ –í—Å–µ –ø—Ä–æ—à–∏–≤–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã!" >> report.md
          cat report.md
          exit 0

      - name: ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–æ—à–∏–≤–∫–∏
        if: steps.check-updates.outputs.updates_found > '0'
        run: |
          echo "–°–∫–∞—á–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ—à–∏–≤–∫–∏..."
          
          # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏ —Ç–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
          while IFS='|' read -r DEVICE VERSION URL STATUS; do
            if [ "$STATUS" = "update" ] || [ "$STATUS" = "new" ]; then
              # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —ç—Ç–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
              rm -f ${DEVICE}_*.bin 2>/dev/null || true
              
              # –°–∫–∞—á–∏–≤–∞–µ–º –Ω–æ–≤—ã–π
              FW_FILENAME="${DEVICE}_${VERSION}.bin"
              echo "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ: $DEVICE $VERSION"
              
              curl -L -s -o "$FW_FILENAME" "$URL"
              
              if [ -f "$FW_FILENAME" ]; then
                FILESIZE=$(stat -c%s "$FW_FILENAME")
                if [ "$FILESIZE" -gt 1000000 ]; then
                  echo "‚úÖ $FW_FILENAME - $FILESIZE –±–∞–π—Ç"
                else
                  echo "‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª, —É–¥–∞–ª—è–µ–º"
                  rm -f "$FW_FILENAME"
                fi
              fi
            fi
          done < devices_info.txt
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø—Ä–æ—à–∏–≤–∫–∏
          while IFS='|' read -r DEVICE VERSION URL STATUS; do
            if [ "$STATUS" = "current" ]; then
              # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
              CURRENT_FILE=$(ls ${DEVICE}_*.bin 2>/dev/null | head -1)
              if [ ! -f "$CURRENT_FILE" ]; then
                echo "‚ö†Ô∏è –ê–∫—Ç—É–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª $DEVICE –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–∫–∞—á–∏–≤–∞–µ–º..."
                FW_FILENAME="${DEVICE}_${VERSION}.bin"
                curl -L -s -o "$FW_FILENAME" "$URL"
              fi
            fi
          done < devices_info.txt

      - name: üè∑Ô∏è –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π —Ä–µ–ª–∏–∑ –µ—Å–ª–∏ –µ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        if: steps.check-updates.outputs.updates_found > '0'
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–ª–∏–∑–æ–≤
          API_URL="https://api.github.com/repos/${{ github.repository }}/releases"
          releases=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$API_URL")
          
          # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–ª–∏–∑ —Å –ø—Ä–æ—à–∏–≤–∫–∞–º–∏
          latest_release=$(echo "$releases" | jq -r '.[0] | select(.tag_name | startswith("firmware-")) | "\(.id)|\(.tag_name)"')
          
          if [ -n "$latest_release" ] && [ "$latest_release" != "null|null" ]; then
            IFS='|' read -r release_id tag_name <<< "$latest_release"
            echo "–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–ª–∏–∑–∞: $tag_name"
            
            # –£–¥–∞–ª—è–µ–º —Ä–µ–ª–∏–∑
            curl -s -X DELETE \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$release_id"
            
            # –£–¥–∞–ª—è–µ–º —Ç–µ–≥
            curl -s -X DELETE \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/$tag_name"
          fi

      - name: üìù –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ä–µ–ª–∏–∑
        if: steps.check-updates.outputs.updates_found > '0'
        run: |
          DATE=$(date +'%Y-%m-%d')
          RELEASE_TAG="firmware-$DATE"
          
          # –°–æ–∑–¥–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
          echo "## UniFi Firmware - $DATE" > release_notes.md
          echo "" >> release_notes.md
          cat updates_info.md >> release_notes.md
          echo "" >> release_notes.md
          echo "**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 1 —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞" >> release_notes.md
          echo "" >> release_notes.md
          echo "**–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:** ${{ steps.set-devices.outputs.devices }}" >> release_notes.md
          
          # –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑
          release_response=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg tag "$RELEASE_TAG" \
              --arg name "UniFi Firmware $DATE" \
              --arg body "$(cat release_notes.md)" \
              '{"tag_name":$tag,"name":$name,"body":$body,"draft":false,"prerelease":false}')" \
            "https://api.github.com/repos/${{ github.repository }}/releases")
          
          upload_url=$(echo "$release_response" | jq -r '.upload_url // empty' | sed 's/{.*}//')
          
          if [ -n "$upload_url" ] && [ "$upload_url" != "null" ]; then
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ .bin —Ñ–∞–π–ª—ã
            for bin_file in *.bin; do
              if [ -f "$bin_file" ]; then
                echo "–ó–∞–≥—Ä—É–∑–∫–∞: $bin_file"
                curl -s -X POST \
                  -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Content-Type: application/octet-stream" \
                  --data-binary @"$bin_file" \
                  "$upload_url?name=$bin_file"
              fi
            done
          fi

      - name: üßπ –û—á–∏—Å—Ç–∫–∞
        if: always()
        run: |
          rm -f firmware_api.json firmware_*.json devices_info.txt updates_info.md release_notes.md report.md 2>/dev/null || true
          git checkout main --force 2>/dev/null || true
