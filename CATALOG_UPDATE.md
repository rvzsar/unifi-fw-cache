# üìã –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ firmware.json

> –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é –∫–∞—Ç–∞–ª–æ–≥–∞ –ø—Ä–æ—à–∏–≤–æ–∫ –∏ —Å–æ–∑–¥–∞–Ω–∏—é –∑–µ—Ä–∫–∞–ª

## üìñ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–ü—Ä–æ–±–ª–µ–º–∞](#-–ø—Ä–æ–±–ª–µ–º–∞)
- [–†–µ—à–µ–Ω–∏–µ](#-—Ä–µ—à–µ–Ω–∏–µ)
- [–ù–æ–≤—ã–µ –æ–ø—Ü–∏–∏](#-–Ω–æ–≤—ã–µ-–æ–ø—Ü–∏–∏)
- [–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è](#-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-–æ–∫—Ä—É–∂–µ–Ω–∏—è)
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
- [–°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#-—Å—Ü–µ–Ω–∞—Ä–∏–∏-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
- [–ü—Ä–∏–º–µ—Ä—ã](#-–ø—Ä–∏–º–µ—Ä—ã)
- [FAQ](#-faq)

---

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–í –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–µ—Ç—è—Ö `/var/lib/unifi/firmware.json` –±—ã—Å—Ç—Ä–æ —É—Å—Ç–∞—Ä–µ–≤–∞–µ—Ç, –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤—ã—Ö –ø—Ä–æ—à–∏–≤–∫–∞—Ö. –≠—Ç–æ —Å–æ–∑–¥–∞—ë—Ç –ø—Ä–æ–±–ª–µ–º—ã:

1. **–£—Å—Ç–∞—Ä–µ–≤—à–∏–π –∫–∞—Ç–∞–ª–æ–≥** - –Ω–æ–≤—ã–µ –ø—Ä–æ—à–∏–≤–∫–∏ –Ω–µ –≤–∏–¥–Ω—ã –≤ WebUI
2. **–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É** - –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥
3. **–†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** - —Ç—Ä—É–¥–æ—ë–º–∫–æ –∏ –ø–æ–¥–≤–µ—Ä–∂–µ–Ω–æ –æ—à–∏–±–∫–∞–º
4. **–†–∞–∑–Ω—ã–µ —Ö–æ—Å—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏** - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

---

## ‚ú® –†–µ—à–µ–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞** —Å:

- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20 –¥–Ω–µ–π)
- üåê –°–∫–∞—á–∏–≤–∞–Ω–∏–µ–º —Å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–ø—Ä–æ–∫—Å–∏, –∑–µ—Ä–∫–∞–ª–æ, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π)
- üîÄ –ü–æ–¥–º–µ–Ω–æ–π —Ö–æ—Å—Ç–æ–≤ –≤ URL –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –∑–µ—Ä–∫–∞–ª–æ–º
- üíæ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- üèóÔ∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å —Ä–µ–∂–∏–º–æ–º –∑–µ—Ä–∫–∞–ª–∞

---

## üîß –ù–æ–≤—ã–µ –æ–ø—Ü–∏–∏

```bash
--update-catalog              # –û–±–Ω–æ–≤–∏—Ç—å firmware.json –∏ –≤—ã–π—Ç–∏
--auto-update-catalog         # –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (–µ—Å–ª–∏ —É—Å—Ç–∞—Ä–µ–ª)
--catalog-url URL             # –ò—Å—Ç–æ—á–Ω–∏–∫ –∫–∞—Ç–∞–ª–æ–≥–∞
                              # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: https://fw-download.ubnt.com/data/firmware.json
--rewrite-catalog-host HOST   # –ù–æ–≤—ã–π —Ö–æ—Å—Ç –¥–ª—è –∑–∞–º–µ–Ω—ã –≤ URL
                              # –ù–∞–ø—Ä–∏–º–µ—Ä: fw-mirror.example.com
                              # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—Å—è https:// –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω
--max-catalog-age DAYS        # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 20 –¥–Ω–µ–π)
--no-catalog-backup           # –ù–µ –¥–µ–ª–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
```

---

## üõ†Ô∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------------|----------|
| `CATALOG_URL` | `https://fw-download.ubnt.com/data/firmware.json` | URL –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ |
| `MAX_CATALOG_AGE` | `20` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∫–∞—Ç–∞–ª–æ–≥–∞ –≤ –¥–Ω—è—Ö |
| `CATALOG_BACKUP` | `1` | –î–µ–ª–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é (1=–¥–∞, 0=–Ω–µ—Ç) |
| `REWRITE_CATALOG_HOST` | - | –•–æ—Å—Ç –¥–ª—è –∑–∞–º–µ–Ω—ã –≤ URL –∫–∞—Ç–∞–ª–æ–≥–∞ |

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:

```bash
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥ —Å –≤–∞—à–µ–≥–æ –∑–µ—Ä–∫–∞–ª–∞
CATALOG_URL=https://fw-mirror.example.com/firmware.json \
  sudo ./unifi-fw-cache.sh --from-catalog --codes "UAP6MP"

# –£–≤–µ–ª–∏—á–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∫–∞—Ç–∞–ª–æ–≥–∞
MAX_CATALOG_AGE=30 \
  sudo ./unifi-fw-cache.sh --auto-update-catalog --from-catalog --codes "U7PG2"
```

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞

```mermaid
flowchart TD
    A[–ó–∞–ø—É—Å–∫ --update-catalog] --> B{–§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?}
    B -->|–î–∞| C[–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é]
    B -->|–ù–µ—Ç| D[–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ]
    C --> E[–°–∫–∞—á–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥ —Å --catalog-url]
    D --> E
    E --> F{–£—Å–ø–µ—à–Ω–æ?}
    F -->|–ù–µ—Ç| G[–û—à–∏–±–∫–∞, –æ—Ç–∫–∞—Ç –∫ backup]
    F -->|–î–∞| H{--rewrite-catalog-host?}
    H -->|–î–∞| I[–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ö–æ—Å—Ç—ã –≤ URL]
    H -->|–ù–µ—Ç| J[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥]
    I --> J
    J --> K[‚úÖ –ì–æ—Ç–æ–≤–æ]
    G --> L[‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π –∫–∞—Ç–∞–ª–æ–≥]
```

### –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```mermaid
flowchart TD
    A[–ó–∞–ø—É—Å–∫ --auto-update-catalog] --> B{–ö–∞—Ç–∞–ª–æ–≥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?}
    B -->|–ù–µ—Ç| C[–û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥]
    B -->|–î–∞| D{–í–æ–∑—Ä–∞—Å—Ç > max-catalog-age?}
    D -->|–î–∞| C
    D -->|–ù–µ—Ç| E[–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π –∫–∞—Ç–∞–ª–æ–≥]
    C --> F{–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ?}
    F -->|–î–∞| G[–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –∑–∞–¥–∞—á—É]
    F -->|–ù–µ—Ç| H[‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π]
    E --> G
    H --> G
```

### –ì–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º (–∑–µ—Ä–∫–∞–ª–æ + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)

```mermaid
flowchart TD
    A[--mirror-all + --update-catalog] --> B[–°–∫–∞—á–∞—Ç—å firmware.json]
    B --> C[–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ö–æ—Å—Ç—ã –Ω–∞ --rewrite-catalog-host]
    C --> D[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ /mirror-root/firmware.json]
    D --> E[–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥]
    E --> F[–ü–∞—Ä—Å–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥]
    F --> G[–°–∫–∞—á–∞—Ç—å –≤—Å–µ –ø—Ä–æ—à–∏–≤–∫–∏]
    G --> H[–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ data/unifi-firmware/...]
    H --> I[‚úÖ –ó–µ—Ä–∫–∞–ª–æ –≥–æ—Ç–æ–≤–æ]
```

---

## üéØ –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### üìå –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ

**–ó–∞–¥–∞—á–∞:** –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–µ—Ç–∏, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–µ—Ä–∫–∞–ª–∞.

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –í cron –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00)
0 3 * * * /opt/unifi-fw-cache.sh --update-catalog \
  --catalog-url https://fw-mirror.example.com/firmware.json \
  --rewrite-catalog-host fw-mirror.example.com \
  >> /var/log/unifi-catalog.log 2>&1
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. ‚úÖ –°–∫–∞—á–∏–≤–∞–µ—Ç —Å–≤–µ–∂–∏–π `firmware.json` —Å –≤–∞—à–µ–≥–æ –∑–µ—Ä–∫–∞–ª–∞
2. ‚úÖ –ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ URL: `https://dl.ui.com/...` ‚Üí `https://fw-mirror.example.com/...`
3. ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `/var/lib/unifi/firmware.json`
4. ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ WebUI –≤–∏–¥–∏—Ç –Ω–æ–≤—ã–µ –ø—Ä–æ—à–∏–≤–∫–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–∏–º–∞–µ—Ç "Cache" –≤ WebUI, –∏ –ø—Ä–æ—à–∏–≤–∫–∏ —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è —Å –≤–∞—à–µ–≥–æ –∑–µ—Ä–∫–∞–ª–∞.

---

### üìå –°—Ü–µ–Ω–∞—Ä–∏–π 2: –°–æ–∑–¥–∞–Ω–∏–µ –∑–µ—Ä–∫–∞–ª–∞ —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º –∫–∞—Ç–∞–ª–æ–≥–æ–º

**–ó–∞–¥–∞—á–∞:** –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω–æ–µ –∑–µ—Ä–∫–∞–ª–æ UniFi –ø—Ä–æ—à–∏–≤–æ–∫ —Å –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–º–∏ URL.

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ù–∞ –±–∞—Å—Ç–∏–æ–Ω-—Ö–æ—Å—Ç–µ (fw-mirror.example.com)
# –ö–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 2:00 –æ–±–Ω–æ–≤–ª—è—Ç—å –∑–µ—Ä–∫–∞–ª–æ
0 2 * * 0 /opt/unifi-fw-cache.sh \
  --update-catalog \
  --catalog-url https://fw-download.ubnt.com/data/firmware.json \
  --rewrite-catalog-host fw-mirror.example.com \
  --mirror-all \
  --mirror-root /srv/www/unifi-mirror \
  >> /var/log/unifi-mirror.log 2>&1
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–µ—Ä–∫–∞–ª–∞:**
```
/srv/www/unifi-mirror/
‚îú‚îÄ‚îÄ firmware.json                    # –ö–∞—Ç–∞–ª–æ–≥ —Å –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–º–∏ —Ö–æ—Å—Ç–∞–º–∏
‚îî‚îÄ‚îÄ data/
    ‚îî‚îÄ‚îÄ unifi-firmware/
        ‚îú‚îÄ‚îÄ U7PG2/
        ‚îÇ   ‚îî‚îÄ‚îÄ 6.7.35.15586/
        ‚îÇ       ‚îî‚îÄ‚îÄ BZ.qca956x_6.7.35+15586.bin
        ‚îú‚îÄ‚îÄ UAP6MP/
        ‚îî‚îÄ‚îÄ ...
```

**–í–µ–±-—Å–µ—Ä–≤–µ—Ä (nginx):**
```nginx
server {
    listen 443 ssl;
    server_name fw-mirror.example.com;

    ssl_certificate /etc/ssl/certs/fw-mirror.example.com.crt;
    ssl_certificate_key /etc/ssl/private/fw-mirror.example.com.key;

    root /srv/www/unifi-mirror;

    location / {
        autoindex on;
    }
}
```

---

### üìå –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤–æ–∑—Ä–∞—Å—Ç–∞

**–ó–∞–¥–∞—á–∞:** –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —É—Å—Ç–∞—Ä–µ–ª (—Å—Ç–∞—Ä—à–µ 20 –¥–Ω–µ–π).

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
sudo ./unifi-fw-cache.sh \
  --from-catalog \
  --auto-update-catalog \
  --max-catalog-age 20 \
  --catalog-url https://fw-mirror.example.com/firmware.json \
  --codes "UAP6MP U7PG2"
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç `/var/lib/unifi/firmware.json`
2. –ï—Å–ª–∏ —Å—Ç–∞—Ä—à–µ 20 –¥–Ω–µ–π ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç
3. –ï—Å–ª–∏ —Å–≤–µ–∂–∏–π ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ–∫—É—â–∏–π
4. –°–∫–∞—á–∏–≤–∞–µ—Ç –ø—Ä–æ—à–∏–≤–∫–∏ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

---

### üìå –°—Ü–µ–Ω–∞—Ä–∏–π 4: –°–æ–∑–¥–∞–Ω–∏–µ –∑–µ—Ä–∫–∞–ª–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏

**–ó–∞–¥–∞—á–∞:** –ù–∞ –º–∞—à–∏–Ω–µ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ —Å–æ–∑–¥–∞—Ç—å –∑–µ—Ä–∫–∞–ª–æ.

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# –ù–∞ –º–∞—à–∏–Ω–µ —Å –ø—Ä–æ–∫—Å–∏
export https_proxy=http://proxy:3128

./unifi-fw-cache.sh \
  --update-catalog \
  --catalog-url https://fw-download.ubnt.com/data/firmware.json \
  --rewrite-catalog-host mirror.company.local \
  --mirror-all \
  --mirror-root /mnt/usb/unifi-mirror

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –±–∞—Å—Ç–∏–æ–Ω-—Ö–æ—Å—Ç
rsync -avz /mnt/usb/unifi-mirror/ bastion:/srv/www/unifi-mirror/
```

---

## üí° –ü—Ä–∏–º–µ—Ä—ã

### –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –≤—Ä—É—á–Ω—É—é

```bash
# –ü—Ä–æ—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
sudo ./unifi-fw-cache.sh --update-catalog

# –° –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ–º —Ö–æ—Å—Ç–æ–≤
sudo ./unifi-fw-cache.sh --update-catalog \
  --rewrite-catalog-host fw-mirror.example.com

# –° –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º
sudo ./unifi-fw-cache.sh --update-catalog \
  --catalog-url https://fw-mirror.example.com/firmware.json

# –ë–µ–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
sudo ./unifi-fw-cache.sh --update-catalog --no-catalog-backup
```

### –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –ø—Ä–æ—à–∏–≤–æ–∫

```bash
# –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥, –µ—Å–ª–∏ —É—Å—Ç–∞—Ä–µ–ª, –∏ —Å–∫–∞—á–∞—Ç—å –ø—Ä–æ—à–∏–≤–∫–∏
sudo ./unifi-fw-cache.sh \
  --auto-update-catalog \
  --from-catalog \
  --codes "UAP6MP U7PG2 UAL6"

# –° –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –≤–æ–∑—Ä–∞—Å—Ç–æ–º
sudo ./unifi-fw-cache.sh \
  --auto-update-catalog \
  --max-catalog-age 30 \
  --from-catalog \
  --codes "U7PG2"
```

### –°–æ–∑–¥–∞–Ω–∏–µ –∑–µ—Ä–∫–∞–ª–∞

```bash
# –ü—Ä–æ—Å—Ç–æ–µ –∑–µ—Ä–∫–∞–ª–æ
./unifi-fw-cache.sh --mirror-all --mirror-root /srv/mirror

# –ó–µ—Ä–∫–∞–ª–æ —Å –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–º –∫–∞—Ç–∞–ª–æ–≥–æ–º
./unifi-fw-cache.sh \
  --update-catalog \
  --rewrite-catalog-host fw-mirror.example.com \
  --mirror-all \
  --mirror-root /srv/mirror

# –ó–µ—Ä–∫–∞–ª–æ —Ç–æ–ª—å–∫–æ –¥–ª—è AP (—Ñ–∏–ª—å—Ç—Ä)
./unifi-fw-cache.sh \
  --update-catalog \
  --rewrite-catalog-host fw-mirror.example.com \
  --mirror-all \
  --mirror-root /srv/mirror \
  --filter "^(UAP|U7)"
```

---

## ‚ùì FAQ

### Q: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞?

**A:** –°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π –∫–∞—Ç–∞–ª–æ–≥ –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É. –í—ã —É–≤–∏–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:
```
‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π
‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π
```

### Q: –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –∫–∞—Ç–∞–ª–æ–≥–∞?

**A:** –í —Ç–æ–π –∂–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –º–µ—Ç–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏:
```bash
/var/lib/unifi/firmware.json.bak.20241219-150830
```

–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ: `--no-catalog-backup`

### Q: –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–¥–º–µ–Ω–∞ —Ö–æ—Å—Ç–æ–≤?

**A:** –§—É–Ω–∫—Ü–∏—è `rewrite_catalog_hosts()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `jq` –¥–ª—è –∑–∞–º–µ–Ω—ã —Ö–æ—Å—Ç–∞ –≤–æ –≤—Å–µ—Ö URL:

**–ë—ã–ª–æ:**
```json
{
  "url": "https://dl.ui.com/unifi/firmware/U7PG2/6.7.35.15586/file.bin"
}
```

**–°—Ç–∞–ª–æ:**
```json
{
  "url": "https://fw-mirror.example.com/unifi/firmware/U7PG2/6.7.35.15586/file.bin"
}
```

**–ü—É—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é**, –º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ö–æ—Å—Ç.

### Q: –ú–æ–∂–Ω–æ –ª–∏ —É–∫–∞–∑–∞—Ç—å HTTP –≤–º–µ—Å—Ç–æ HTTPS?

**A:** –î–∞, —Ñ—É–Ω–∫—Ü–∏—è `normalize_host()` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞:

```bash
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç https://
--rewrite-catalog-host fw-mirror.example.com

# –ò–ª–∏ —è–≤–Ω–æ —É–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ç–æ–∫–æ–ª
--rewrite-catalog-host http://fw-mirror.example.com
--rewrite-catalog-host https://fw-mirror.example.com
```

### Q: –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç –∫–∞—Ç–∞–ª–æ–≥–∞?

**A:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É:

```bash
# –í–æ–∑—Ä–∞—Å—Ç —Ñ–∞–π–ª–∞ –≤ –¥–Ω—è—Ö
echo $(( ($(date +%s) - $(stat -c%Y /var/lib/unifi/firmware.json)) / 86400 )) –¥–Ω–µ–π

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
source unifi-fw-cache.sh
check_catalog_age /var/lib/unifi/firmware.json 20
```

### Q: –ú–æ–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–∞—Ç–∞–ª–æ–≥ –±–µ–∑ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø—Ä–æ—à–∏–≤–æ–∫?

**A:** –î–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `--update-catalog` –±–µ–∑ –¥—Ä—É–≥–∏—Ö –æ–ø—Ü–∏–π:

```bash
sudo ./unifi-fw-cache.sh --update-catalog
```

–°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–∏—Ç –∫–∞—Ç–∞–ª–æ–≥ –∏ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.

### Q: –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∑–µ—Ä–∫–∞–ª–∞?

**A:** –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx:

```nginx
server {
    listen 443 ssl http2;
    server_name fw-mirror.example.com;

    ssl_certificate /etc/ssl/certs/fw-mirror.example.com.crt;
    ssl_certificate_key /etc/ssl/private/fw-mirror.example.com.key;

    root /srv/www/unifi-mirror;

    # –ö–∞—Ç–∞–ª–æ–≥
    location = /firmware.json {
        add_header Content-Type application/json;
    }

    # –ü—Ä–æ—à–∏–≤–∫–∏
    location /data/ {
        autoindex on;
    }

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    access_log /var/log/nginx/fw-mirror.example.com.access.log;
    error_log /var/log/nginx/fw-mirror.example.com.error.log;
}
```

### Q: –ú–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ cron?

**A:** –î–∞:

```bash
# /etc/cron.d/unifi-fw-cache
CATALOG_URL=https://fw-mirror.example.com/firmware.json
MAX_CATALOG_AGE=20

0 3 * * * root /opt/unifi-fw-cache.sh --update-catalog --rewrite-catalog-host fw-mirror.example.com
```

---

## üéì –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø–æ–∏—Å–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

–°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É –ø–æ–∏—Å–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤:

```mermaid
flowchart TD
    A[–ü–æ–∏—Å–∫ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤] --> B{–ï—Å—Ç—å MD5?}
    B -->|–î–∞| C[–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ü–æ–∏—Å–∫ –ø–æ MD5]
    B -->|–ù–µ—Ç| D{–ï—Å—Ç—å –≤–µ—Ä—Å–∏—è?}
    C --> E{–ù–∞–π–¥–µ–Ω–æ?}
    E -->|–î–∞| F[‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤]
    E -->|–ù–µ—Ç| D
    D -->|–î–∞| G[–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ + –≤–µ—Ä—Å–∏–∏]
    D -->|–ù–µ—Ç| H[–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞]
    G --> I{–ù–∞–π–¥–µ–Ω–æ?}
    I -->|–î–∞| F
    I -->|–ù–µ—Ç| H
    H --> J{–ù–∞–π–¥–µ–Ω–æ?}
    J -->|–î–∞| F
    J -->|–ù–µ—Ç| K[Fallback: –ö–æ–¥ –∏–∑ URL]
    K --> L[‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–∏–Ω –∫–æ–¥]
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û–¥–Ω–∞ –ø—Ä–æ—à–∏–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤—Å–µ—Ö —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –º–æ–¥–µ–ª–µ–π!

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å JSON –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º:

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –≤—Ä—É—á–Ω—É—é
jq empty /var/lib/unifi/firmware.json && echo "‚úÖ –í–∞–ª–∏–¥–Ω—ã–π JSON" || echo "‚ùå –û—à–∏–±–∫–∞"
```

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è:

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
cp /var/lib/unifi/firmware.json.bak.20241219-150830 /var/lib/unifi/firmware.json
```

### –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞:

```bash
# –î–ª—è —Ä–µ–∂–∏–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
chown unifi:unifi /var/lib/unifi/firmware.json
chmod 0644 /var/lib/unifi/firmware.json
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –∫–∞—Ç–∞–ª–æ–≥–∞

```bash
# –í–æ–∑—Ä–∞—Å—Ç –∫–∞—Ç–∞–ª–æ–≥–∞
stat -c "%y" /var/lib/unifi/firmware.json

# –í–µ—Ä—Å–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
jq 'keys | max' /var/lib/unifi/firmware.json
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–µ —Ö–æ—Å—Ç—ã

```bash
# –°–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ö–æ—Å—Ç–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
jq -r '.[][] .release | .[].url' /var/lib/unifi/firmware.json | \
  grep -oP 'https?://\K[^/]+' | sort -u
```

### –†–∞–∑–º–µ—Ä –∑–µ—Ä–∫–∞–ª–∞

```bash
# –†–∞–∑–º–µ—Ä –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
du -sh /srv/www/unifi-mirror/

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—à–∏–≤–æ–∫
find /srv/www/unifi-mirror/ -name "*.bin" -o -name "*.tar" | wc -l
```

---

<div align="center">

**‚ú® –¢–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–º –ø—Ä–æ—à–∏–≤–æ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–æ! ‚ú®**

Made with ‚ù§Ô∏è for Network Engineers

</div>
